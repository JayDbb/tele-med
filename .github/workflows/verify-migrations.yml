name: Verify DB Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        run: npm ci
      - name: Validate migration via SQL introspection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npm run validate:migration || true
      - name: Run visit type test (service role)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npm run test:migration || true

      - name: Install Supabase CLI
        if: ${{ secrets.DATABASE_URL }}
        run: |
          npm i -g supabase@latest

      - name: Apply DB migrations via Supabase CLI
        if: ${{ secrets.DATABASE_URL }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # configure remote database and push local migrations
          supabase db remote set "$DATABASE_URL"
          supabase db push

      - name: Verify migrations were applied
        if: ${{ secrets.DATABASE_URL }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npm run verify:migrations:applied

      - name: Run transcription E2E test (service role + worker)
        if: ${{ secrets.SUPABASE_URL && secrets.SUPABASE_SERVICE_ROLE_KEY && secrets.STORAGE_BUCKET }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
          DEV_ADMIN_TOKEN: ${{ secrets.DEV_ADMIN_TOKEN }}
          REPLICATE_API_KEY: ${{ secrets.REPLICATE_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Build the worker and run it in background to process jobs
          npm run build:worker
          # start worker in background (it will create .worker-ready when ready)
          nohup npm run worker:dist -- --once &> worker.log &
          # wait for worker to be ready (timeout 15s)
          node scripts/wait-for-worker.js --timeout=15000
          # Run the E2E test which enqueues a job using service role and waits for processing
          npm run test:transcription:e2e
          # show worker logs for debugging
          tail -n +1 worker.log || true

      - name: Run medications E2E test (service role)
        if: ${{ secrets.SUPABASE_URL && secrets.SUPABASE_SERVICE_ROLE_KEY }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npm run test:medications:e2e

      - name: Run messages E2E test (service role)
        if: ${{ secrets.SUPABASE_URL && secrets.SUPABASE_SERVICE_ROLE_KEY }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npm run test:messages:e2e
